<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=author content><meta name=description content="Script (deployable to k8s) to log requests from vulnerability and exploit scanners."><link rel=icon href=https://hightower.space/img/favicon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin=anonymous referrerpolicy=no-referrer><meta name=keywords content=" hugo  latex  theme "><meta property="og:title" content="Logging Scans from Vulnerability and Exploit Scanners (for Fun)"><meta property="og:description" content="Script (deployable to k8s) to log requests from vulnerability and exploit scanners."><meta property="og:type" content="article"><meta property="og:url" content="https://hightower.space/posts/k8s-scanner-collector/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-01T00:00:00+00:00"><link rel=canonical href=https://hightower.space/posts/k8s-scanner-collector/><meta itemprop=name content="Logging Scans from Vulnerability and Exploit Scanners (for Fun)"><meta itemprop=description content="Script (deployable to k8s) to log requests from vulnerability and exploit scanners."><meta itemprop=datePublished content="2022-09-01T00:00:00+00:00"><meta itemprop=dateModified content="2022-09-01T00:00:00+00:00"><meta itemprop=wordCount content="670"><meta itemprop=keywords content="GoLang,Vulnerabilities,Exploits,Scanners,Threat Intelligence,DigitalOcean,k8s,DOKS,Docker,Load Balancers,"><link media=screen rel=stylesheet href=https://hightower.space/css/common.css><link media=screen rel=stylesheet href=https://hightower.space/css/content.css><title>Logging Scans from Vulnerability and Exploit Scanners (for Fun) - Floyd</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Logging Scans from Vulnerability and Exploit Scanners (for Fun)"><meta name=twitter:description content="Script (deployable to k8s) to log requests from vulnerability and exploit scanners."><link rel=stylesheet href=https://hightower.space/css/single.css></head><body><div id=wrapper><header id=header><h1><a href=https://hightower.space/>Floyd</a></h1><p class=description>A digital space for sharing my thoughts.</p><br><nav><span class=nav-bar-item><a class=link href=/>Home</a></span>
<span class=nav-bar-item><a class=link href=/categories/reading-list>Reading Lists</a></span>
<span class=nav-bar-item><a class=link href=/tags>Tags</a></span>
<span class=nav-bar-item><a class=link href=/skills>Skills</a></span>
<span class=nav-bar-item><a class=link href=/posts>All Posts</a></span>
<span class=nav-bar-item><a class=link href=/about>About</a></span></nav></header><main id=main class=post><h1>Logging Scans from Vulnerability and Exploit Scanners (for Fun)</h1><div><a class=link href=https://hightower.space/tags/golang>#GoLang</a>
<a class=link href=https://hightower.space/tags/vulnerabilities>#Vulnerabilities</a>
<a class=link href=https://hightower.space/tags/exploits>#Exploits</a>
<a class=link href=https://hightower.space/tags/scanners>#Scanners</a>
<a class=link href=https://hightower.space/tags/threat-intelligence>#Threat Intelligence</a>
<a class=link href=https://hightower.space/tags/digitalocean>#DigitalOcean</a>
<a class=link href=https://hightower.space/tags/k8s>#k8s</a>
<a class=link href=https://hightower.space/tags/doks>#DOKS</a>
<a class=link href=https://hightower.space/tags/docker>#Docker</a>
<a class=link href=https://hightower.space/tags/load-balancers>#Load Balancers</a></div><article class=content><h2 id=intro>Intro</h2><p>In this post, I explain a script (deployable to k8s) which will log incoming requests to collect requests from vulnerability and exploit scanners.</p><p>It&rsquo;s very basic and is not meant for any production use-cases, but it just a fun project to learn more about GoLang, k8s, and vulnerability scanners.</p><h2 id=overview>Overview</h2><p>You can find the scanner on Github <a href=https://github.com/fhightower/k8s-scanner-collector>here</a>.</p><p>We&rsquo;ll deploy it to a k8s cluster (I&rsquo;m using <a href=https://docs.digitalocean.com/products/kubernetes/>DigitalOcean&rsquo;s Kubernetes service</a> (DOKS)) and see what vulnerability and exploit scanners hit our app!</p><p>If you&rsquo;ve never built a docker image, pushed it to a registry, and/or deployed that image to k8s, you can keep reading this post as I&rsquo;ll walk you through the process, but you may also find
DigitalOcean&rsquo;s <a href=https://docs.digitalocean.com/tutorials/build-and-deploy-your-first-image-to-your-first-cluster/>guide on the subject</a> helpful.</p><h2 id=the-process>The process</h2><p>The process requires four steps:</p><ol><li>Create a docker image</li><li>Push docker image to a registry</li><li>Deploy that image to a k8s cluster</li><li>View logs showing scanner activity</li></ol><p>So let&rsquo;s jump in!</p><h3 id=create-docker-image>Create Docker Image</h3><p>To create a docker image locally, we start by cloning the <a href=https://github.com/fhightower/k8s-scanner-collector>repo</a>:</p><pre tabindex=0><code>git clone git@github.com:fhightower/k8s-scanner-collector.git;
cd k8s-scanner-collector;
</code></pre><p>and we build a docker image with the name <code>scanner-collector</code> like:</p><pre tabindex=0><code>docker build -t scanner-collector .
</code></pre><p>You can look at the <code>Dockerfile</code> to see what is included in this docker image.</p><p>You can then run the image you created with:</p><pre tabindex=0><code>docker run -p 80:80 scanner-collector
</code></pre><p>which will run the scanner on http://localhost:80.</p><p>If you run this locally, you can see that, for each request, it logs:</p><ul><li>The requested path</li><li>The IP from which the request is coming (we make a best effort to find this)</li></ul><h3 id=push-docker-image-to-registry>Push Docker Image to Registry</h3><p>Next, we&rsquo;ll deploy our docker image to a registry (in this case, in DigitalOcean, but the process should be similar for different cloud providers).</p><p>To do this, we&rsquo;ll use the <a href=https://docs.digitalocean.com/reference/doctl/how-to/install/>doctl</a> cli.</p><p>We start by <a href=https://cloud.digitalocean.com/account/api/tokens/new>creating a token</a> and then running this command which
will prompt you for your token:</p><pre tabindex=0><code>doctl auth init
</code></pre><p>Now, if you don&rsquo;t already have a registry, run:</p><pre tabindex=0><code>doctl registry create &lt;registry-name&gt;
</code></pre><p>where <code>&lt;registry-name></code> is globally unique.
If you already have a registry in DigitalOcean, you an skip this step.</p><p>Next, we login into our registry:</p><pre tabindex=0><code>doctl registry login
</code></pre><p>Now, run this command to let docker know which image we want to push to the registry:</p><pre tabindex=0><code>docker tag scanner-collector registry.digitalocean.com/&lt;registry-name&gt;/scanner-collector
</code></pre><p>and push it to the registry:</p><pre tabindex=0><code>docker push registry.digitalocean.com/&lt;registry-name&gt;/scanner-collector
</code></pre><p>To make sure it has been pushed successfully, we can run it locally using the image from the registry:</p><pre tabindex=0><code>docker run -p 80:80 registry.digitalocean.com/&lt;registry-name&gt;/scanner-collector
</code></pre><h3 id=deploy-image-to-k8s>Deploy Image to k8s</h3><p>Now, we&rsquo;re ready to deploy our image to k8s.</p><p>First, we create a new cluster with sane defaults:</p><pre tabindex=0><code>doctl kubernetes cluster create &lt;cluster-name&gt; --tag scanner-collector --auto-upgrade=true --node-pool &#34;name=mypool;count=2;auto-scale=true;min-nodes=1;max-nodes=3;tag=scanner-collector&#34;
</code></pre><p>(see more details on this command <a href=https://docs.digitalocean.com/tutorials/build-and-deploy-your-first-image-to-your-first-cluster/#step-5-create-a-cluster>here</a>).</p><p>Now, we need to give our cluster access to our private registry:</p><pre tabindex=0><code>doctl registry kubernetes-manifest | kubectl apply -f -
kubectl patch serviceaccount default -p &#39;{&#34;imagePullSecrets&#34;: [{&#34;name&#34;: &#34;registry-&lt;registry-name&gt;&#34;}]}&#39;
</code></pre><p>(see more details about these commands <a href=https://docs.digitalocean.com/tutorials/build-and-deploy-your-first-image-to-your-first-cluster/#step-6-run-your-app-on-a-cluster>here</a>).</p><p>Now for the fun part&mldr; let&rsquo;s deploy the collector:</p><pre tabindex=0><code>kubectl create deployment scanner-collector --image=registry.digitalocean.com/&lt;registry-name&gt;/scanner-collector
</code></pre><p>You can view the pods with:</p><pre tabindex=0><code>kubectl get pods
</code></pre><p>Now, let&rsquo;s add a load balancer so our service is publicly accessible:</p><pre tabindex=0><code>kubectl expose deployment scanner-collector --type=LoadBalancer --port=80 --target-port=80
</code></pre><p>This can take a few minutes to get created, but you can run this until the <code>Status</code> field is <code>active</code>:</p><pre tabindex=0><code>doctl compute load-balancer list --format Name,Created,IP,Status
</code></pre><p>Once <code>Status</code> is <code>active</code>, you should see an IP address which is the public IP for your deployment.</p><p>You can visit that IP address in your browser and will see your app.</p><h3 id=view-logs-showing-scanner-activity>View Logs Showing Scanner Activity</h3><p>Now that we have a publicly accessible app, we can look at the logs to see if there&rsquo;s anyone scanning our IP for vulnerabilities or exploits.</p><p>I recommend running:</p><pre tabindex=0><code>kubectl get pods
</code></pre><p>and then, using a pod name from the output from the last command:</p><pre tabindex=0><code>kubectl logs &lt;pod-name&gt;
</code></pre><p>This will show some odd traffic like a request to <code>/?XDEBUG_SESSION_START=phpstorm</code> trying to take advantage of <a href=https://www.exploit-db.com/ghdb/6763>this</a> vulnerability.</p><p>Enjoy and <a href=mailto:11floyd@proton.me>let me know</a> if you find anything particularly interesting!</p></article><div class=paginator><a class=link href=https://hightower.space/posts/orders-of-mag-scoring-system/>← prev</a>
<a class=link href=https://hightower.space/posts/2023-reading-list/>next →</a></div><div class=comment></div></main><footer id=footer><div><span>© 2019</span> - <span>2023</span></div><div><span>Powered by</span>
<a class=link href=https://gohugo.io/>Hugo</a>
<span>| Theme</span>
<a class=link href=https://github.com/fhightower/hugo-theme-texify>TeXify</a></div><div class=footnote><span><a class=link href=https://github.com/fhightower>GitHub</a> |
<a class=link href="https://500px.com/p/fhightower?view=photos">500px</a> |
<a class=link href=mailto:floyd.hightower27@gmail.com>Email</a> |
<a class=link href=/index.xml>RSS</a></span></div></footer></div></body></html>